<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultImage - Генератор изображений</title>
    <style>
        :root {
            --primary-color: #6a0dad;
            --primary-dark: #4b0082;
            --text-color: #000000;
            --light-bg: #f9f9f9;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
            color: var(--text-color);
        }

        body {
            background-color: var(--light-bg);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background-color: var(--white);
            padding: 1rem;
            box-shadow: var(--shadow);
            position: relative;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .requests-counter {
            position: relative;
            cursor: pointer;
        }

        .counter-btn {
            background-color: var(--primary-color);
            color: white;
            border: 2px solid var(--primary-dark);
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .counter-btn:hover {
            background-color: var(--primary-dark);
        }

        .requests-count {
            color: white;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 0.5rem;
            z-index: 10;
            min-width: 150px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-menu button {
            width: 100%;
            padding: 0.5rem;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            border-radius: 4px;
        }

        .dropdown-menu button:hover {
            background-color: #f0f0f0;
        }

        main {
            flex: 1;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .hero {
            text-align: center;
            margin-bottom: 2rem;
        }

        .hero h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: 2px solid var(--primary-dark);
            border-radius: 8px;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0.5rem 0;
        }

        .btn:hover {
            background-color: var(--primary-dark);
        }

        .btn:disabled {
            background-color: #cccccc;
            border-color: #999999;
            cursor: not-allowed;
        }

        .generate-section {
            display: none;
            flex-direction: column;
            align-items: center;
        }

        .generate-section.active {
            display: flex;
        }

        .prompt-input {
            width: 100%;
            max-width: 600px;
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1rem;
            resize: none;
            min-height: 100px;
        }

        .results-title {
            margin: 1.5rem 0 0.5rem;
            font-size: 1.2rem;
        }

        .generated-image {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin: 1rem 0;
            display: none;
        }

        .no-requests {
            background-color: #fff3cd;
            color: #856404;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
            display: none;
        }

        .no-requests a {
            color: var(--primary-dark);
            font-weight: bold;
            text-decoration: underline;
            cursor: pointer;
        }

        .topup-section {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            max-width: 500px;
            margin: 0 auto;
        }

        .topup-section.active {
            display: flex;
        }

        .amount-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .ton-price {
            margin: 1rem 0;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .payment-status {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            display: none;
            text-align: center;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .payment-link {
            word-break: break-all;
            color: var(--primary-dark);
            text-decoration: underline;
            cursor: pointer;
        }

        .loading {
            display: none;
            margin: 1rem 0;
            text-align: center;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .requests-counter {
                margin-top: 1rem;
            }

            .dropdown-menu {
                right: auto;
                left: 50%;
                transform: translateX(-50%);
            }

            .prompt-input {
                min-height: 80px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">MultImage</div>
            <div class="requests-counter">
                <button class="counter-btn" id="requestsBtn">Запросы: <span class="requests-count" id="requestsCount">0</span></button>
                <div class="dropdown-menu" id="dropdownMenu">
                    <button id="topupBtn">Пополнить</button>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="no-requests" id="noRequests">
            У вас закончились запросы, пожалуйста, <a id="topupLink">пополните запросы</a>
        </div>

        <section class="hero" id="mainSection">
            <h2>Генерируй изображения по описанию</h2>
            <button class="btn" id="startBtn">Начать</button>
        </section>

        <section class="generate-section" id="generateSection">
            <textarea class="prompt-input" id="promptInput" placeholder="Опишите изображение, которое хотите сгенерировать (например: 'Реалистичный чайник на кухонном столе, высокое качество')"></textarea>
            <button class="btn" id="generateBtn">Сгенерировать</button>
            
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>Генерация изображения...</p>
            </div>

            <h3 class="results-title">Результат</h3>
            <div id="resultsContainer">
                <img class="generated-image" id="generatedImage" alt="Сгенерированное изображение">
                <button class="btn" id="downloadBtn">Скачать фото</button>
            </div>
        </section>

        <section class="topup-section" id="topupSection">
            <h2 class="topup-title">Пополнение запросов</h2>
            <div style="margin-bottom: 1rem;">Доступно запросов: <span id="currentRequests">0</span></div>
            
            <input type="number" class="amount-input" id="amountInput" placeholder="Сколько запросов купить?" min="1" value="50">
            <div class="ton-price" id="tonPrice">Цена: 0 TON</div>
            
            <button class="btn" id="payWithTonBtn">Оплатить TON</button>
            <div class="payment-status" id="paymentStatus"></div>
            
            <button class="btn" id="backToGenBtn" style="margin-top: 2rem;">Вернуться к генерации</button>
        </section>
    </main>

    <script>
        // Конфигурация
        const CRYPTO_BOT_TOKEN = '445505:AAUOeEl6V0kIz47rg37qr218KJgTTlkt9A2';
        const PRICE_PER_REQUEST = 2; // 1 запрос = 2 рубля
        let currentTonPrice = 150; // Начальное значение курса TON/RUB

        // Элементы интерфейса
        const requestsBtn = document.getElementById('requestsBtn');
        const dropdownMenu = document.getElementById('dropdownMenu');
        const requestsCount = document.getElementById('requestsCount');
        const noRequests = document.getElementById('noRequests');
        const topupLink = document.getElementById('topupLink');
        const startBtn = document.getElementById('startBtn');
        const generateBtn = document.getElementById('generateBtn');
        const promptInput = document.getElementById('promptInput');
        const generatedImage = document.getElementById('generatedImage');
        const downloadBtn = document.getElementById('downloadBtn');
        const loading = document.getElementById('loading');
        const mainSection = document.getElementById('mainSection');
        const generateSection = document.getElementById('generateSection');
        const topupSection = document.getElementById('topupSection');
        const topupBtn = document.getElementById('topupBtn');
        const backToGenBtn = document.getElementById('backToGenBtn');
        const currentRequests = document.getElementById('currentRequests');
        const amountInput = document.getElementById('amountInput');
        const tonPrice = document.getElementById('tonPrice');
        const payWithTonBtn = document.getElementById('payWithTonBtn');
        const paymentStatus = document.getElementById('paymentStatus');

        // Инициализация LocalStorage
        if (!localStorage.getItem('requests')) {
            localStorage.setItem('requests', '5'); // Начальные 5 бесплатных запросов
        }

        // Генерация случайного ID пользователя
        if (!localStorage.getItem('userId')) {
            localStorage.setItem('userId', Math.random().toString(36).substring(2, 15));
        }

        // Обновление интерфейса
        function updateUI() {
            const requests = parseInt(localStorage.getItem('requests')) || 0;
            requestsCount.textContent = requests;
            currentRequests.textContent = requests;

            if (requests <= 0) {
                noRequests.style.display = 'block';
                generateBtn.disabled = true;
            } else {
                noRequests.style.display = 'none';
                generateBtn.disabled = false;
            }
        }

        // Получаем курс TON/RUB
        async function getTonPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=the-open-network&vs_currencies=rub');
                const data = await response.json();
                if (data && data['the-open-network']) {
                    currentTonPrice = data['the-open-network'].rub;
                    updateTonPrice();
                }
            } catch (error) {
                console.error('Ошибка получения курса TON:', error);
                // Используем значение по умолчанию
                updateTonPrice();
            }
        }

        // Обновляем отображение цены в TON
        function updateTonPrice() {
            const requests = parseInt(amountInput.value) || 1;
            const rubAmount = requests * PRICE_PER_REQUEST;
            const tonAmount = (rubAmount / currentTonPrice).toFixed(4);
            tonPrice.textContent = `Цена: ${tonAmount} TON (${rubAmount}₽)`;
        }

        // Создание платежа в CryptoBot
        async function createCryptoPayment(amountRub) {
            const amountTon = (amountRub / currentTonPrice).toFixed(4);
            const requests = Math.round(amountRub / PRICE_PER_REQUEST);
            
            try {
                const response = await fetch('https://pay.crypt.bot/api/createInvoice', {
                    method: 'POST',
                    headers: {
                        'Crypto-Pay-API-Token': CRYPTO_BOT_TOKEN,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        asset: 'TON',
                        amount: amountTon,
                        description: `Пополнение ${requests} запросов`,
                        payload: JSON.stringify({
                            userId: localStorage.getItem('userId'),
                            requests: requests
                        })
                    })
                });

                const data = await response.json();
                
                if (data.ok && data.result) {
                    return {
                        success: true,
                        payUrl: data.result.pay_url,
                        invoiceId: data.result.invoice_id,
                        requests: requests
                    };
                } else {
                    throw new Error(data.error || 'Неизвестная ошибка');
                }
            } catch (error) {
                console.error('Ошибка создания платежа:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // Проверка статуса платежа
        async function checkPaymentStatus(invoiceId) {
            try {
                const response = await fetch(`https://pay.crypt.bot/api/getInvoices?invoice_ids=${invoiceId}`, {
                    headers: {
                        'Crypto-Pay-API-Token': CRYPTO_BOT_TOKEN
                    }
                });
                const data = await response.json();
                
                if (data.ok && data.result.items.length > 0) {
                    return data.result.items[0].status; // "active" или "paid"
                }
            } catch (error) {
                console.error('Ошибка проверки платежа:', error);
            }
            return null;
        }

        // Генерация изображения (заглушка)
        async function generateImage(prompt) {
            loading.style.display = 'block';
            generateBtn.disabled = true;

            try {
                // Здесь должна быть ваша логика генерации изображений
                // Для примера используем заглушку
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Уменьшаем количество запросов
                const currentRequests = parseInt(localStorage.getItem('requests')) || 0;
                localStorage.setItem('requests', (currentRequests - 1).toString());

                // Показываем заглушку изображения
                generatedImage.src = `https://picsum.photos/512/512?random=${Date.now()}`;
                generatedImage.onload = function() {
                    loading.style.display = 'none';
                    generatedImage.style.display = 'block';
                    downloadBtn.style.display = 'block';
                    updateUI();
                };
            } catch (error) {
                console.error('Ошибка генерации:', error);
                alert('Произошла ошибка при генерации изображения. Попробуйте другой запрос.');
                loading.style.display = 'none';
                generateBtn.disabled = false;
            }
        }

        // Скачивание изображения
        function downloadImage() {
            const link = document.createElement('a');
            link.href = generatedImage.src;
            link.download = `generated-${Date.now()}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            updateUI();
            getTonPrice();
            
            // Обновляем цену при изменении количества
            amountInput.addEventListener('input', updateTonPrice);
            
            // Обработка оплаты
            payWithTonBtn.addEventListener('click', async function() {
                const requests = parseInt(amountInput.value) || 1;
                const rubAmount = requests * PRICE_PER_REQUEST;
                
                payWithTonBtn.disabled = true;
                paymentStatus.style.display = 'none';
                
                const payment = await createCryptoPayment(rubAmount);
                
                if (payment.success) {
                    // Открываем ссылку на оплату
                    window.open(payment.payUrl, '_blank');
                    
                    // Показываем статус
                    paymentStatus.innerHTML = `
                        <p>Ожидание оплаты...</p>
                        <p>Сумма: ${(rubAmount / currentTonPrice).toFixed(4)} TON</p>
                        <p>Будет зачислено: ${payment.requests} запросов</p>
                        <p>Ссылка для оплаты: <span class="payment-link" id="paymentLink">${payment.payUrl}</span></p>
                    `;
                    
                    document.getElementById('paymentLink').onclick = () => window.open(payment.payUrl, '_blank');
                    
                    paymentStatus.className = 'payment-status success';
                    paymentStatus.style.display = 'block';
                    
                    // Проверяем статус платежа каждые 5 секунд
                    const checkInterval = setInterval(async () => {
                        const status = await checkPaymentStatus(payment.invoiceId);
                        
                        if (status === 'paid') {
                            clearInterval(checkInterval);
                            const currentRequests = parseInt(localStorage.getItem('requests')) || 0;
                            localStorage.setItem('requests', currentRequests + payment.requests);
                            updateUI();
                            
                            paymentStatus.innerHTML = `
                                <p>✅ Оплачено успешно!</p>
                                <p>Зачислено: ${payment.requests} запросов</p>
                            `;
                        }
                    }, 5000);
                } else {
                    paymentStatus.innerHTML = `<p>Ошибка: ${payment.error}</p>`;
                    paymentStatus.className = 'payment-status error';
                    paymentStatus.style.display = 'block';
                }
                
                payWithTonBtn.disabled = false;
            });

            // Обработчики событий
            requestsBtn.addEventListener('click', function() {
                dropdownMenu.classList.toggle('show');
            });

            window.addEventListener('click', function(event) {
                if (!event.target.matches('.counter-btn')) {
                    dropdownMenu.classList.remove('show');
                }
            });

            topupBtn.addEventListener('click', function() {
                mainSection.style.display = 'none';
                generateSection.style.display = 'none';
                topupSection.classList.add('active');
                dropdownMenu.classList.remove('show');
            });

            topupLink.addEventListener('click', function() {
                mainSection.style.display = 'none';
                generateSection.style.display = 'none';
                topupSection.classList.add('active');
            });

            startBtn.addEventListener('click', function() {
                mainSection.style.display = 'none';
                generateSection.classList.add('active');
            });

            generateBtn.addEventListener('click', function() {
                const prompt = promptInput.value.trim();
                if (prompt) {
                    generateImage(prompt);
                } else {
                    alert('Пожалуйста, введите описание изображения');
                }
            });

            downloadBtn.addEventListener('click', downloadImage);

            backToGenBtn.addEventListener('click', function() {
                topupSection.classList.remove('active');
                generateSection.classList.add('active');
            });
        });
    </script>
</body>
</html>
